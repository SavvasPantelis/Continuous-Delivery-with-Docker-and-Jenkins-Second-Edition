pipeline {
    agent any

    environment {
        REPORT_DIR = 'build/reports/tests/acceptanceTest' // Ensure this points to the right folder for XML reports
    }

    stages {
        stage('Checkout SCM') {
            steps {
                script {
                    checkout scm
                }
            }
        }

        stage('Ensure gradlew is executable') {
            steps {
                sh 'chmod +x Chapter09/sample1/gradlew'
            }
        }

        stage('Build JAR') {
            steps {
                dir('Chapter08/sample1') {
                    // Build the JAR file from Chapter08
                    sh './gradlew clean build --no-daemon'
                }
            }
        }

        stage('Run Acceptance Tests') {
            steps {
                dir('Chapter09/sample1') {
                    // Run the acceptance tests
                    sh './gradlew acceptanceTest --no-daemon'
                }
            }
        }

        stage('Publish Test Report') {
            steps {
                script {
                    // Publish the JUnit test results in Jenkins
                    junit '**/build/reports/tests/acceptanceTest/*.xml' // Path to the generated JUnit XML report
                }
            }
        }

        stage('Cleanup') {
            steps {
                script {
                    // Cleanup any leftover Docker containers or artifacts
                    sh 'docker rm -f calculator || true'
                    cleanWs()
                }
            }
        }
    }

    post {
        always {
            echo 'Pipeline completed!'
        }
        success {
            echo 'Build and tests were successful!'
        }
        failure {
            echo 'There were errors in the pipeline!'
        }
    }
}

